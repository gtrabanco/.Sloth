#!/usr/bin/env bash
#shellcheck disable=2016

set -o pipefail

#shellcheck disable=SC1091
. "${SLOTH_PATH:-$DOTLY_PATH}/scripts/core/src/_main.sh"

##? Usage:
##?    dot self-update
##?    dot autoupdate
##?    dot -h | --help
##?    dot -v | --version
##?    dot <context> <script> [<args>...]
##?    dot <context>
##?    dot
VERSION="2.0.0"
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  docs::parse "$@"
fi

if [[ "$1" == "-v" || "$1" == "--version" ]]; then
  output::write "dot v${VERSION}"
  exit
fi

if [[ "$1" == "self-update" ]]; then
  "$SLOTH_PATH/bin/dot" core update
  exit
fi

if [[ "$1" == "autoupdate" ]]; then
  "$SLOTH_PATH/bin/dot" core async-update
  exit
fi



fzf_prompt() {
  local paths="$1"

  script="$(
    echo "$paths" |
      xargs -I % sh -c 'echo "$(basename $(dirname %)) $(basename %)"' |
      fzf \
        --height 100% \
        --preview '"$DOTLY_PATH/bin/dot" $(echo {} | cut -d" " -f 1) $(echo {} | cut -d" " -f 2) -h'
  )"

  printf "%s" "$script"
  read -r args

  "$DOTLY_PATH/bin/dot" "$script" "$args"
}

script_exist() {
  [[ -x "${1}/scripts/${2}/${3}" ]]
}

if args::has_no_args "$@"; then
  fzf_prompt "$(dot::list_scripts_path)"
elif args::total_is 1 "$@"; then
  fzf_prompt "$(dot::list_scripts_path | grep "/$1/")"
else
  context="$1"
  script="$2"

  shift 2

  script_path=""
  script_exist "$DOTFILES_PATH" "$context" "$script" && script_path="$DOTFILES_PATH"
  script_exist "$DOTLY_PATH" "$context" "$script" && script_path="$DOTLY_PATH"

  if [ -z "$script_path" ]; then
    output::error "The script <$context / $script> doesn't exist"
    exit 1
  fi

  script_full_path="${script_path}/scripts/${context}/${script}"
  if grep -q "FORCE_LEGACY_EXECUTION" "$script_full_path" ||
      grep -q "docs::parse" "$script_full_path" || 
      grep -q "\$DOTLY_PATH/scripts/core/_main.sh" "$script_full_path" || 
      grep -q "\$DOTLY_PATH/scripts/core/src/_main.sh" "$script_full_path" || 
      grep -q "\$SLOTH_PATH/scripts/core/_main.sh" "$script_full_path" || 
      grep -q "\$SLOTH_PATH/scripts/core/src/_main.sh" "$script_full_path" || 
      grep -q "\${SLOTH_PATH:-\$DOTLY_PATH}/scripts/core/_main.sh" "$script_full_path" || 
      grep -q "\${SLOTH_PATH:-\$DOTLY_PATH}/scripts/core/src/_main.sh" "$script_full_path"; then
    "${script_path}/scripts/${context}/${script}" "$@"
  else
    "${script_path}/scripts/core/sloth_script" "${script_path}/scripts/${context}/${script}" "$@"
  fi
fi
